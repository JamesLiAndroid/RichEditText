#仿微博富文本编辑框

没图我说个毛？

<img src='screenshot/screenshot.gif' height='480px'/>

首先要说明的是：不管是话题、at还是poi，都应该被看成一个最小子项，即不可在中间插入文字，也不可对话题、at或者poi中的任何文字进行单独的修改或者删除。

结合以上，该富文本编辑框的主要功能如下：

- 1、富文本的高亮处理；
- 2、点击话题、at或者poi时光标会落在旁边合适的位置，光标移动时，如果碰到话题等要直接移动跳过整个话题，而不是仍然逐个文字的移动；
- 3、删除话题、at或者poi时，先整体选中，再点一次删除则执行真正的删除操作；
- 4、对于poi这种特殊类型，需要支持图文混排的展示；
- 5、除了对输入的文字进行展示，同时也要有良好的格式以便将用户输入的内容保存或者传输到服务器。

下面，就开始逐个分析吧。

##富文本的高亮处理
这个简单，就是富文本的处理。

##边界判断

现在的很多输入法的键盘都有上、下、左、右移动光标的功能，比如搜狗输入法：

<img src='screenshot/keyboard.png' height='180px'/>

所谓边界判断，就是当用户在键盘上移动光标、或者直接用手指点击输入框调整光标的位置时，如果移动时碰到话题等特殊内容时，自动调整光标到旁边合适的位置。

###监听光标位置
要监听光标的位置，TextView中有一个方法叫`onSelectionChanged`，完整声明如下：

```
    protected void onSelectionChanged(final int selStart, final int selEnd) {
	}
```
当光标每次的位置发生改变时都会回调这个方法，两个形参即分别代表了光标的开始位置和结束位置。

而触发`onSelectionChanged`这个方法的原因基本上有两个：

- 1、用户手动输入文字，导致文字改变同时光标也向后移；
- 2、开发者手动调用`setSelection()`方法移动光标从而导致`onSelectionChanged `的回调。

###调整光标位置
上面说到调整光标的位置，`setSelection()`正好符合我们的需要。该方法在EditText中的完整声明如下：

```
    public void setSelection(int index) {
	}
	
    public void setSelection(int start, int stop) {
	}
```
`setSelection()`有两个重名方法，上面那个是纯粹的移动光标，下面那个是选中一段文字或者调整选区。

对于第1种情况处理起来比较简单，我们主要考虑第2种情况。我们来看一个图：

<img src='screenshot/doubleSelection.png' height='480px'/>

用户选中中间一段文字之后，如果此时点击键盘上的 "<-"、"->"，此时应该一次性选中富文本，而不是逐个选中每个文字。

###如何判断光标移动到了话题旁边？
好了，监听以及调整光标位置的事情已经解决了，我怎么知道光标移动到了话题、at或者poi的旁边呢？

这就涉及到了正则表达式了。不管是话题、at还是poi，我们都要分别给每种富文本定义一个格式，这里用话题来举例。

话题的格式是：一个空格+一个#+话题内容+一个空格，即" #话题 "（引号内即为一个完整的话题，至于为什么话题不像大家平常见到的那样是两个话题，我们稍后再讲）。

定下了话题格式之后，就可以写出正则表达式：" #[^#+] "，表示两个空格中间的字符串是#开头的若干个字符。这里推荐一个[在线正则表达式测试](http://tool.oschina.net/regex/)给大家，非常好用。

有了正则表达式，就可以针对话题提供一系列方法：判断字符串中是否包含话题、获取字符串中第一个话题、判断字符串是否以话题开头，等等。

看到这里，怎么判断光标旁边是否是话题就已经非常简单了：

- 1、如果光标是往左移，取光标左边的字符串，并判断这个字符串是否以话题结尾；
- 2、如果光标是往右移，取光标右边的字符串，并判断这个字符串是否以话题开头；

##删除话题
View类中有个方法是`setOnKeyListener(OnKeyListener l)`,通过它可以设置对设备按键的事件进行监听，我们这里只需要监听`KeyEvent.KEYCODE_DEL`即可，每当用户按下删除键遍判断光标前面的字符串是否是话题，如果是话题则计算该话题的长度并选中之，如果再次点击删除即删除之。

如果前面的字符串是话题，那怎么判断到底是选中还是删除呢？

第一次按删除时，光标start和end的值肯定是相同的，因为只有一个光标，这时按下删除键肯定是执行选中话题的操作；

选中话题之后，光标变成了两个，这时候start和end值变成了两个，这时候按删除键就直接删除话题了。

所以只需要判断光标start和end的值是否一样即可。

##POI图文混排
平时做图文混排的方式有很多种，但是这里用的是ImageSpan，就不讲了。

##格式化保存
这是最主要的问题，也是之前困扰我很长一段时间的问题，其实回过头来看看也并没有我想的那么复杂，因为我们在前面定义话题格式、写话题正则表达式的时候，一个这样的字符串`这里有一个话题 #话题 不信你看`其实已经包含了很多信息了，所以我们并不需要额外的数据来存储任何其他的信息。

当时想的东西比较多，这么简单一说可能你们不能体会到上面这段话的意思，也可能我表达的不够好。

下面开始分析代码吧。

##源码分析

###架构设计
下面是程序uml类图。

<img src='uml.png' height='537px' width='1483px'/>

###话题、AT、POI，以及以后任何可能的富文本样式

###RichEditText

##没解决的bug
程序大部分功能基本上没有问题，但是删除话题有的时候删不了，因为有个先选中再删除的过程，不知道为什么选中的时候老是选中不了，所以造成删除话题时一直跳过。

解决办法是：去掉先选中再删除的逻辑，当删除时碰到话题，按删除即直接删除整个话题，而不要选中了。

如果解决了bug我会及时更新的。